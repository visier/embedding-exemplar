<!--
    Copyright Â© [2010-2023] Visier Solutions Inc. All rights reserved.
-->

<!--
    This page embeds Visier charts into a partner's application. This document has three sections that correspond to
    the three elements required to embed a Visier chart:
        1. Create containers
            - The parent application must create a container (i.e., `div`) for each of the Visier charts it embeds.
              Each container must have a unique `id`.
        2. Embed charts
            - Copy (or modify) the embedding script provided by clicking on the "embed" action on an Analysis.
        3. Add message handlers
            - Handle messages emitted by Visier's scripts.
-->

<!--
    ****************************** 1. Create containers ****************************************************************
    The partner application creates a container (i.e., `div`) for each of the charts it embeds. Each chart has a unique
    id. Here, we use `#chart-container-1`, `#chart-container-2`, and `#chart-container-3`.
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Embed A Visier Chart</title>
    <link type="text/css" rel="stylesheet" href="main.css">
</head>
<body>
<main>
    <div id="page-container">
        <div id="title-container">
            <h1 class="title">Embedded Charts</h1>
            <h3 class="subtitle">The partner application embeds selected Visier visuals into its own content.</h3>
        </div>
        <div id="content-container">
            <div class="chart-containers">
                <!--
                    These will eventually contain the Visier charts. Content inside of the container will be replaced
                    by the chart when it renders.
                 -->
                <div class="chart-container center-both" id="chart-container-1"><img src="loading.gif" /></div>
                <div class="chart-container center-both" id="chart-container-2"><img src="loading.gif" /></div>
                <div class="chart-container center-both" id="chart-container-3"><img src="loading.gif" /></div>
            </div>
        </div>
    </div>
    <script id="visier-embedding-script">
        /**
         * ****************************************** 2. Embed charts **************************************************
         * This section is provided by Visier. Click on the "embed" action of an analysis you wish to embed and copy the
         * script it provides. If you want to embed more than one chart, as we do here, set `visierConfig` to the list
         * of charts you will embed.
         */
        // Included for reference only: This is the configuration for embedding a single chart.
        const visierConfigSingleChart = {
            loginUrl: "{{vanityURL}}/hr/auth/embedded",
            idpUrl: "https://127.0.0.1/connectVisierSession", // Required if `enableHiddenSession` is true
            enableHiddenSession: true,
            contentId: "bbfdf21b-1f37-4504-8397-ac97043555f1",
            containerId: "chart-container-1"
        };

        // The configuration for embedding multiple charts.
        const visierConfig = {
            loginUrl: "{{vanityUrl}}/hr/auth/embedded",
            idpUrl: "https://127.0.0.1/connectVisierSession", // Required only if `enableHiddenSession` is true
            enableHiddenSession: true,
            charts: [{
                contentId: "bbfdf21b-1f37-4504-8397-ac97043555f1",
                containerId: "chart-container-1"
            }, {
                contentId: "b16a1ac4-3b92-47e9-b22b-3bf00d2fa829",
                containerId: "chart-container-2"
            }, {
                contentId: "bbfdf21b-1f37-4504-8397-ac97043555f1",
                containerId: "chart-container-3"
            }],
        };

        // This is part of the content copied from Visier's "embed" action on an Analysis. It will be the same for any
        // and all analyses you embed.
        (function(w, d, t, s, c, v, e, x) {
            w['VisierEmbedder'] = v;
            w[v] = w[v] || function() {
                (w[v].q = w[v].q || []).push(arguments)
            };
            e = d.createElement(t);
            x = d.getElementsByTagName(t)[0];
            e.async = true;
            e.src = c.loginUrl.split("/auth/embedded")[0] + s;
            x.parentNode.insertBefore(e, x)
        })(window, document, 'script', '/assets/embedded/webAssets/sdk.js', visierConfig, 'visier');
        visier('bootstrap', visierConfig); // "bootstrap" must always be the first call to `visier()`.

        /**
         * ****************************************** 3. Add message handlers ******************************************
         * Here, we simply log messages emitted by Visier and provide a generic error message in the container. A
         * production application will have more sophisticated error handling.
         */
        function handleMessage(messageType) {
            return function(data) {
                if (messageType === 'ERROR' && data.source) {
                    const container = document.getElementById(data.source);
                    container.innerHTML = "Error loading Visier chart. See console for details.";
                }
                const source = data.source ? "[" + data.source + "] " : "";
                console.log(`${messageType} ${source}${JSON.stringify(data || "No data provided")}`);
            }
        }

        visier('on', 'info', handleMessage('INFO'));
        visier('on', 'error', handleMessage('ERROR'));
        visier('on', 'session', handleMessage('SESSION'));
        visier('on', 'bootstrapped', handleMessage('BOOTSTRAP'));
    </script>
</main>
</body>
</html>
